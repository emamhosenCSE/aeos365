import{r,e as J,j as e,d as Q,s as le,F as oe,b as L,f as ie}from"./app-DInl32dX.js";import{u as ce,a as T,p as de,r as me,c as ue,D as fe,b as pe,s as xe,K as he,P as ge}from"./sortable.esm-CKq_driz.js";import{y as k}from"./index-DPMKIREV.js";import ye from"./KanbanColumn-e1xH7wCK.js";import ve from"./DealCard-_BoY2Ikv.js";import{F as je,d as Ce,a as be,c as Se,b as we,m as R,e as De}from"./PlusIcon-CsvijEwK.js";import{F as U}from"./CurrencyDollarIcon-B3zwuJ0N.js";import{F as Ne}from"./MagnifyingGlassIcon-BHtwTbT7.js";import{t as D}from"./chunk-AUA5GDXN-D3hqgLS_.js";import{i as _e}from"./chunk-SQIAVXJX-D14i8yCn.js";import"./app-Bq-q9uAS.js";import"./DocumentIcon-CBf8GOfS.js";import"./chunk-C6WKGNND-BNiYL7Dh.js";import"./chunk-VFIJPDYX-CGLJS4zn.js";import"./useProgressBar-DFqNCtAi.js";import"./number-CB4zbwAz.js";import"./useLabel-CkOStKP1.js";import"./useLabels-DRQXF7iz.js";import"./useNumberFormatter-DySMALVF.js";import"./NumberFormatter-DNR9MAW-.js";import"./chunk-P7ACKWSP-8b9-fXrc.js";import"./UserIcon-BXV25mJ2.js";import"./CalendarDaysIcon-C0QniVM8.js";import"./chunk-CV4BWJDJ-DcxL8QrL.js";import"./index-BCLbv8my.js";import"./index-CSng9BnJ.js";import"./Item-DGSYw1SN.js";import"./SelectionManager-C4bZoYw_.js";import"./keyboard-DNevlDsW.js";import"./index-C19oxd6b.js";import"./useDialog-8HGvvybm.js";import"./VisuallyHidden-CS7DyqzD.js";import"./chunk-WQVQ7P2I-CFFCRwf1.js";import"./index-gV97IVYX.js";import"./useSelectableItem-BDDZlxQu.js";import"./chunk-IHO36JMK-D4pDtZyX.js";import"./useTreeState-wpFJCnLf.js";import"./useMenuTriggerState-CjU22Gti.js";import"./chunk-LGMZDQT5-AEtpri7C.js";import"./chunk-KQW2TNLT-BWWZAnNV.js";import"./chunk-ICU6NNET-DqkKT8ny.js";const ys=({initialPipeline:C,initialColumns:V=[],initialSummary:q={},users:Ie=[]})=>{const[c,p]=r.useState(()=>V.map(s=>({...s,deals:s.deals||[]}))),[x,h]=r.useState(q),[Fe,O]=r.useState(null),[K,z]=r.useState(null),[$,P]=r.useState(!1),[G,W]=r.useState(!1),[N,B]=r.useState(""),[A,ke]=r.useState(null),[_,H]=r.useState("all"),[o,b]=r.useState(null),X=ce(T(ge,{activationConstraint:{distance:8}}),T(he,{coordinateGetter:xe})),Y=r.useCallback(s=>{const t=de(s),n=me(s),a=ue(s);return t.length>0?t:n.length>0?n:a},[]),g=r.useCallback(s=>c.find(t=>t.deals.some(n=>n.id===s)),[c]),I=r.useCallback(s=>{const t=s.toString().replace("stage-","");return c.find(n=>n.id.toString()===t)},[c]),E=r.useCallback(s=>{for(const t of c){const n=t.deals.find(a=>a.id===s);if(n)return n}return null},[c]),F=r.useCallback(s=>new Intl.NumberFormat("en-US",{style:"currency",currency:C?.currency||"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),[C?.currency]),M=r.useCallback(s=>{const t=s.flatMap(a=>a.deals),n=t.filter(a=>a.status==="open");return{total_deals:t.length,total_value:t.reduce((a,i)=>a+(i.value||0),0),weighted_value:t.reduce((a,i)=>a+(i.value||0)*((i.probability||0)/100),0),rotting_deals:n.filter(a=>a.is_rotting).length}},[]),Z=r.useCallback(s=>{const{active:t}=s;O(t.id),z(E(t.id)),b({columns:JSON.parse(JSON.stringify(c)),summary:{...x}})},[c,x,E]),ee=r.useCallback(s=>{const{active:t,over:n}=s;if(!n)return;const a=t.id,i=n.id,S=g(a);let l=g(i);!l&&i.toString().startsWith("stage-")&&(l=I(i)),!(!S||!l||S.id===l.id)&&p(f=>{const y=f.findIndex(u=>u.id===S.id),v=f.findIndex(u=>u.id===l.id),m=f[y].deals.find(u=>u.id===a);if(!m)return f;const d=[...f];d[y]={...d[y],deals:d[y].deals.filter(u=>u.id!==a)};const w=l.deals.findIndex(u=>u.id===i),j=w>=0?w:l.deals.length,ne={...m,probability:l.probability};return d[v]={...d[v],deals:[...d[v].deals.slice(0,j),ne,...d[v].deals.slice(j)]},d})},[g,I]),se=r.useCallback(async s=>{const{active:t,over:n}=s;if(O(null),z(null),!n){o&&(p(o.columns),h(o.summary)),b(null);return}const a=t.id,i=n.id,S=g(a);let l=g(i);if(!l&&i.toString().startsWith("stage-")&&(l=I(i)),!S||!l){o&&(p(o.columns),h(o.summary)),b(null);return}const f=l.deals.findIndex(m=>m.id===a),y=f>=0?f+1:l.deals.length,v=l.id;h(M(c)),W(!0);try{const m=await J.post(route("crm.deals.move",{deal:a}),{pipeline_stage_id:v,position:y});m.data.success&&(m.data.deal&&p(d=>d.map(w=>({...w,deals:w.deals.map(j=>j.id===a?{...j,...m.data.deal}:j)}))),k.success("Deal moved successfully",{position:"bottom-right",autoClose:2e3}))}catch(m){console.error("Failed to sync deal move:",m),o&&(p(o.columns),h(o.summary));const d=m.response?.data?.message||"Failed to move deal. Please try again.";k.error(d,{position:"bottom-right",autoClose:4e3})}finally{W(!1),b(null)}},[c,g,I,o,M]),te=r.useCallback(()=>{O(null),z(null),o&&(p(o.columns),h(o.summary)),b(null)},[o]),ae=r.useMemo(()=>c.map(s=>({...s,deals:s.deals.filter(t=>{if(N){const n=N.toLowerCase();if(!(t.title?.toLowerCase().includes(n)||t.deal_number?.toLowerCase().includes(n)||t.customer?.name?.toLowerCase().includes(n)))return!1}return!(A&&t.assigned_to!==A||_!=="all"&&t.status!==_)})})),[c,N,A,_]),re=r.useCallback(async()=>{P(!0);try{const s=await J.get(route("crm.pipeline.data",{pipeline:C.id}));s.data.columns&&p(s.data.columns),s.data.summary&&h(s.data.summary),k.success("Pipeline refreshed",{position:"bottom-right",autoClose:1500})}catch(s){console.error("Failed to refresh pipeline:",s),k.error("Failed to refresh. Please try again.")}finally{P(!1)}},[C?.id]);return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 mb-4 px-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:C?.name||"Sales Pipeline"}),G&&e.jsxs(Q,{size:"sm",variant:"flat",color:"primary",children:[e.jsx(le,{size:"sm",className:"mr-1"}),"Syncing..."]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(D,{content:"Total Deals",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-default-600",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:x.total_deals||0})]})}),e.jsx(D,{content:"Total Value",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-success-600",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:F(x.total_value||0)})]})}),e.jsx(D,{content:"Weighted Value",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-primary-600",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:F(x.weighted_value||0)}),e.jsx("span",{className:"text-xs text-default-400",children:"(weighted)"})]})}),x.rotting_deals>0&&e.jsx(D,{content:"Rotting Deals",children:e.jsxs(Q,{size:"sm",color:"warning",variant:"flat",children:[e.jsx(oe,{className:"w-3.5 h-3.5 mr-1"}),x.rotting_deals," rotting"]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{size:"sm",placeholder:"Search deals...",value:N,onChange:s=>B(s.target.value),startContent:e.jsx(Ne,{className:"w-4 h-4 text-default-400"}),className:"w-48",isClearable:!0,onClear:()=>B("")}),e.jsxs(Ce,{children:[e.jsx(be,{children:e.jsx(L,{size:"sm",variant:"flat",startContent:e.jsx(Se,{className:"w-4 h-4"}),children:"Filters"})}),e.jsxs(we,{"aria-label":"Filter options",selectionMode:"single",selectedKeys:[_],onSelectionChange:s=>H(Array.from(s)[0]||"all"),children:[e.jsx(R,{children:"All Deals"},"all"),e.jsx(R,{children:"Open Only"},"open"),e.jsx(R,{children:"Won"},"won"),e.jsx(R,{children:"Lost"},"lost")]})]}),e.jsx(D,{content:"Refresh pipeline",children:e.jsx(L,{size:"sm",variant:"flat",isIconOnly:!0,onPress:re,isLoading:$,children:e.jsx(ie,{className:"w-4 h-4"})})}),e.jsx(L,{size:"sm",color:"primary",startContent:e.jsx(De,{className:"w-4 h-4"}),children:"New Deal"})]})]}),e.jsxs(fe,{sensors:X,collisionDetection:Y,onDragStart:Z,onDragOver:ee,onDragEnd:se,onDragCancel:te,children:[e.jsx("div",{className:`\r
                        flex-1 flex gap-4 overflow-x-auto pb-4 px-2\r
                        scrollbar-thin scrollbar-thumb-default-300 \r
                        scrollbar-track-transparent\r
                    `,children:ae.map(s=>e.jsx(ye,{stage:s,deals:s.deals,isLoading:$,formatCurrency:F},s.id))}),e.jsx(pe,{dropAnimation:null,children:K?e.jsx("div",{className:"opacity-90 rotate-3 scale-105",children:e.jsx(ve,{deal:K,isDragging:!0,formatCurrency:F})}):null})]})]})};export{ys as default};
